<html>

<head>
    <meta charset="utf-8">
    <title>WAITER 許可証発行 DB比較</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="http://canvasjs.com/assets/script/canvasjs.min.js"></script>
</head>

<body>
    <div id="chartContainer1" style="width: 100%; height: 450px;display: inline-block;"></div>
    <br>
    <div id="chartContainer2" style="width: 100%; height: 450px;display: inline-block;"></div>

    <script>
        var time = new Date();
        var endpoint = 'http://localhost:8081';
        var accessToken;
        var numberOfPassportsIssuedWithMongoDB = 0;
        var numberOfPassportsIssuedWithRedis = 0;
        var numberOfPassportsIssuedWithSqlServer = 0;

        $.ajax({
            url: `${endpoint}/oauth/token`,
            method: 'POST',
            data: {
                grant_type: 'client_credentials',
                client_id: 'motionpicture',
                scope: ['admin']
            }
        }).done(function (data) {
            accessToken = data.access_token;
            console.log('accessToken:', accessToken);
        }).fail(function (jqXHR, textStatus) {
            console.error(jqXHR, textStatus);
        });

        // チャート初期化
        var chart1 = new CanvasJS.Chart("chartContainer1",
            {
                title: {
                    text: "WAITER number of passorts issued"
                },
                data: [
                    {
                        type: "spline",
                        name: "MongoDB",
                        showInLegend: true,
                        dataPoints: [
                            { x: time, y: 0 }
                        ]
                    },
                    {
                        type: "spline",
                        name: "Redis",
                        showInLegend: true,
                        dataPoints: [
                            { x: time, y: 0 }
                        ]
                    },
                    {
                        type: "spline",
                        name: "SQL Server",
                        showInLegend: true,
                        dataPoints: [
                            { x: time, y: 0 }
                        ]
                    }
                ]
            });
        var chart2 = new CanvasJS.Chart("chartContainer2",
            {
                title: {
                    text: "WAITER number of passorts issued2"
                },
                data: [
                    {
                        type: "spline",
                        name: "MongoDB",
                        showInLegend: true,
                        dataPoints: [
                            { x: time, y: 0 }
                        ]
                    },
                    {
                        type: "spline",
                        name: "Redis",
                        showInLegend: true,
                        dataPoints: [
                            { x: time, y: 0 }
                        ]
                    },
                    {
                        type: "spline",
                        name: "SQL Server",
                        showInLegend: true,
                        dataPoints: [
                            { x: time, y: 0 }
                        ]
                    }
                ]
            });


        chart1.render();
        chart2.render();


        // チャートにデータを追加し続ける
        setInterval(function () {
            var time = new Date();
            // 時点での発行数データを追加
            chart1.options.data[0].dataPoints.push({ x: time, y: numberOfPassportsIssuedWithMongoDB });
            chart1.options.data[1].dataPoints.push({ x: time, y: numberOfPassportsIssuedWithRedis });
            chart1.options.data[2].dataPoints.push({ x: time, y: numberOfPassportsIssuedWithSqlServer });
            chart1.options.data[0].dataPoints = chart1.options.data[0].dataPoints.slice(-30);
            chart1.options.data[1].dataPoints = chart1.options.data[1].dataPoints.slice(-30);
            chart1.options.data[2].dataPoints = chart1.options.data[2].dataPoints.slice(-30);

            chart2.options.data[0].dataPoints.push({ x: time, y: numberOfPassportsIssuedWithMongoDB });
            chart2.options.data[1].dataPoints.push({ x: time, y: numberOfPassportsIssuedWithRedis });
            chart2.options.data[2].dataPoints.push({ x: time, y: numberOfPassportsIssuedWithSqlServer });

            chart1.render();
            chart2.render();
        }, 500);

        // 許可証を発行し続ける
        setInterval(function () {
            $.ajax({
                url: `${endpoint}/passports?db=mongodb`,
                method: 'POST',
                data: {
                    scope: 'testscope'
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
                }
            }).done(function (data) {
                if (data.token) {
                    numberOfPassportsIssuedWithMongoDB += 1;
                    console.log('numberOfPassportsIssuedWithMongoDB:', numberOfPassportsIssuedWithMongoDB);
                }
            }).fail(function (jqXHR, textStatus) {
                console.error(jqXHR, textStatus);
            });
        }, 250);
        setInterval(function () {
            $.ajax({
                url: `${endpoint}/passports?db=redis`,
                method: 'POST',
                data: {
                    scope: 'testscope'
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
                }
            }).done(function (data) {
                if (data.token) {
                    numberOfPassportsIssuedWithRedis += 1;
                    console.log('numberOfPassportsIssuedWithRedis:', numberOfPassportsIssuedWithRedis);
                }
            }).fail(function (jqXHR, textStatus) {
                console.error(jqXHR, textStatus);
            });
        }, 250);
        setInterval(function () {
            $.ajax({
                url: `${endpoint}/passports?db=sqlserver`,
                method: 'POST',
                data: {
                    scope: 'testscope'
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
                }
            }).done(function (data) {
                if (data.token) {
                    numberOfPassportsIssuedWithSqlServer += 1;
                    console.log('numberOfPassportsIssuedWithSqlServer:', numberOfPassportsIssuedWithSqlServer);
                }
            }).fail(function (jqXHR, textStatus) {
                console.error(jqXHR, textStatus);
            });
        }, 250);
    </script>
</body>

</html>